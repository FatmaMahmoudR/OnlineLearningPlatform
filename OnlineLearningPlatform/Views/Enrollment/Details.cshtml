@model OnlineLearningPlatform.Models.Enrollment
@using System.Security.Claims

@{
	ViewData["Title"] = "Details";
}

<head>
	<title>My Courses </title>

	<!-- Meta -->
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="author" content="Xiaoying Riley at 3rd Wave Media">
	<link rel="shortcut icon" href="@Url.Content("~/CrsLanding/assets/favicon.ico")">

	<!-- Google Font -->
	<link href="https://fonts.googleapis.com/css?family=Montserrat:800|Roboto:400,500,700&display=swap" rel="stylesheet">

	<!-- FontAwesome JS-->
	<script defer src="@Url.Content("~/CrsLanding/assets/fontawesome/js/all.min.js")"></script>

	<!-- Theme CSS -->
	<link id="theme-style" rel="stylesheet" href="@Url.Content("~/CrsLanding/assets/css/theme.css")">


</head>

@{

	string ExtractYouTubeVideoId(string url)
	{
		if (url.Contains("youtu.be/"))
		{
			// youtu.be/ID
			var index = url.IndexOf("youtu.be/") + 9;
			return url.Substring(index, 11);
		}
		else if (url.Contains("v="))
		{
			// youtube.com/watch?v=ID
			var index = url.IndexOf("v=") + 2;
			return url.Substring(index, 11);
		}
		return string.Empty;
	}
}


<body>

	<header class="header">
		<section class="hero-section" style="background:url('@Url.Content("~/CrsLanding/assets/images/bg.png")')">

			<div class="hero-mask">
			</div><!--//hero-mask-->
			<div class="container text-center py-5">
				<div class="single-col-max mx-auto">

					<h1 class="hero-heading mb-5">
						<span class="brand mb-4 d-block"><span class="text-highlight pr-2">{ </span><span class="name">@Model?.Course?.Category</span><span class="text-highlight pl-2"> }</span></span>
						<span class="desc d-block"> @Model?.Course?.Name</span>
					</h1>
					<!-- if not enrolled -->
					<!-- <div class="text-center mb-5">
						<a href="#section-pricing" class="btn btn-primary btn-lg scrollto">Start Learning Now</a>
					</div> -->

					<div class="hero-summary">
						<div class="row">
							<div class="item col-4">
								<div class="summary-desc mb-1"><i class="icon fas fa-video me-2"></i>Content</div>
								<h4 class="summary-heading">80+ <span class="desc">Videos</span></h4>

							</div><!--//col-->
							<div class="item col-4">
								<div class="summary-desc mb-1"><i class="fas fa-bolt me-2"></i> </i>Level</div>
								<h4 class="summary-heading"> @Model?.Course?.DifficultyLevel </h4>

							</div><!--//col-->
							<div class="item col-4">
								<div class="summary-desc mb-1"><i class="icon fas fa-user-circle me-2"></i>Instructor</div>
								<h4 class="summary-heading">@Model?.Course?.Instructor?.AppUser?.UserName</h4>

							</div><!--//col-->
						</div><!--//row-->
					</div><!--//hero-summary-->
				</div><!--//single-col-max-->
			</div><!--//container-->

		</section><!--//hero-section-->
	</header><!--//header-->

	<div class="sections-wrapper">

		<div class="section-blocks mb-5">

			<div id="section-overview" class="section-overview section pt-md-4 pt-lg-5">
				<div class="container py-5">
					<div class="section-col-max mx-auto">
						<h3 class="section-title text-center mb-4">What Will You Learn</h3>
						<p class="mb-4">@Model?.Course?.Description</p>

						<!-- if not enrolled -->
						<!-- <div class="text-center mb-5">
							<a class="btn btn-primary scrollto" href="#section-pricing">Join Course Now</a>
						</div> -->

					</div><!--//section-col-max-->
				</div><!--//container-->
			</div><!--//section-overview-->





			<div id="section-content" class="section-content section">
				<div class="container py-5">
					<div class="section-col-max mx-auto">
						<h3 class="text-center mb-4">Course Content</h3>
						<div class="accordion module-accordion" id="module-accordion">

							<div class="module-item card">

								<div id="module-1" class="module-content collapse show" aria-labelledby="module-heading-1">
									<div class="card-body p-0">
										@{
											int i = 1;
										}
										@foreach (var lesson in Model?.Course?.Lessons)
										{
											<div class="module-sub-item p-3">
												<div class="row justify-content-between">
													<div class="col-9">
														<span class="theme-text-secondary me-2">@i</span>
														@{
															i++;
														}
														<a class="video-play-trigger" href="#" data-bs-toggle="modal" data-bs-target="#modal-video-@lesson.Id">
															@if (lesson.Iscompleted)
															{
																<i class="fas fa-circle-check fa-solid " style="color: #1cb048;"></i>
															}
															else
															{
																<i class="fas fa-circle-check fa-regular fa-beat"></i>
															}
															@lesson.Title
														</a>
													</div>
													<div class="col-3 text-end extra-info">02:30</div>
												</div>
											</div>

											<!-- Video Modal with unique ID -->
											<div class="modal modal-video" id="modal-video-@lesson.Id" tabindex="-1" role="dialog" aria-hidden="true">
												<div class="modal-dialog">
													<div class="modal-content">
														<button type="button" class="btn-close" data-bs-dismiss="modal" aria-hidden="true">&times;</button>
														<div class="modal-body">
															<div class="ratio ratio-16x9">
																@if (!string.IsNullOrEmpty(lesson.FilePath))
																{
																	var originalUrl = lesson.FilePath;
																	var videoId = ExtractYouTubeVideoId(originalUrl);
																	var embedUrl = $"https://www.youtube.com/embed/{videoId}";

																	<iframe id="videoPlayer-@lesson.Id" width="560" height="315" src="@embedUrl" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
																}
															</div>
														</div>
													</div>
												</div>
											</div>
										}


									</div><!--//card-body-->
								</div><!--//module-content-->
							</div><!--//module-item-->
							<!-- if not enrolled -->
							<!-- <div class="text-center mt-5">
									  <a class="btn btn-primary scrollto" href="#section-pricing">Enrol Now</a>
								  </div>
							</div> -->


						</div><!--//container-->
					</div><!--//section-content-->
				</div>


			</div>
		</div>
	</div>

	<!-- Javascript -->
	<script src="@Url.Content("~/CrsLanding/assets/plugins/popper.min.js")"></script>
	<script src="@Url.Content("~/CrsLanding/assets/plugins/bootstrap/js/bootstrap.min.js")"></script>
	<script src="@Url.Content("~/CrsLanding/assets/js/main.js")"></script>

@* 
	 <script>
	 	// Load the YouTube IFrame Player API code asynchronously
	 	var tag = document.createElement('script');
	 	tag.src = "https://www.youtube.com/iframe_api";
	 	var firstScriptTag = document.getElementsByTagName('script')[0];
	 	firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

	 	// Define the player variable
	 	var players = {}; // Object to hold player instances

	 	// This function is called when the IFrame API is ready to create a player
	 	function onYouTubeIframeAPIReady() {
	 		// Initialize players for each video in the modal
	 		document.querySelectorAll('.modal-video').forEach(function (modal) {
	 			var lessonId = modal.id.replace('modal-video-', '');
	 			var iframe = modal.querySelector('iframe');

	 			players[lessonId] = new YT.Player(iframe, {
	 				// No need for events related to state changes since we are marking on open
	 			});

	 			// Add an event listener to mark the lesson as completed when the modal opens
	 			modal.addEventListener('show.bs.modal', function () {
	 				markLessonCompleted(lessonId); // Mark the lesson as completed
	 			});
	 		});
	 	}

	 	// Function to mark the lesson as completed via AJAX
	 	function markLessonCompleted(lessonId) {
	 		const enrollmentId = /* Your logic to get enrollment ID */;

	 		fetch('/Enrollment/MarkLessonCompleted', {
	 			method: 'POST',
	 			headers: {
	 				'Content-Type': 'application/json'
	 			},
	 			body: JSON.stringify({ enrollmentId: enrollmentId, lessonId: lessonId })
	 		})
	 			.then(response => {
	 				if (!response.ok) {
	 					throw new Error('Network response was not ok');
	 				}
	 				return response.json();
	 			})
	 			.then(data => {
	 				if (data.success) {
	 					console.log('Lesson marked as completed successfully for lesson ID: ' + lessonId);
	 					// Optionally, update the UI to reflect the lesson is completed
	 					document.querySelector(`#modal-video-${lessonId} .video-play-trigger i`).classList.remove('fa-regular');
	 					document.querySelector(`#modal-video-${lessonId} .video-play-trigger i`).classList.add('fa-solid', 'fa-circle-check');
	 					// Show a success message or notification to the user
	 				} else {
	 					console.error(data.message);
	 					// Optionally, display the error message to the user
	 				}
	 			})
	 			.catch(error => {
	 				console.error('There was a problem with the fetch operation:', error);
	 				// Optionally, handle the error here (e.g., notify the user)
	 			});
	 	}


	 </script> *@



</body>

